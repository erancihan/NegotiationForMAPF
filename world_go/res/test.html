<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WS</title>
</head>
<body>
<div>
    <input id="world_id" type="text">
    <button id="test_btn">Test</button>
    <button id="dc_btn">Disconnect</button>
</div>
<pre>
    <span>Server   : </span><span id="server"></span>
    <span>Status   : </span><span id="status"></span>
    <span>msg count: </span><span id="mc"></span>
    <span>delay    : </span><span id="delay">0.000</span>ms
    <span>client_t : </span><span id="client_t">x</span>ns
    <span>server_t : </span><span id="server_t">x</span>ns
    <br />
    <span id="raw"></span>
</pre>
<script>
    var ws;

    function TestStart () {
        console.log('on test clicked');

        var wid = document.getElementById('world_id').value;
        var loc = window.location;
        var srv = 'ws://localhost:3000/world';
        var uri = srv + '/' + wid;

        var mc = 0;

        var dced = false;
        ws = new WebSocket(uri);

        ws.onopen = function () {
            document.getElementById('server').innerText = uri;
            document.getElementById('status').innerText = 'connected';
            console.log('connected');
        };

        ws.onerror = function (ev) {
            document.getElementById('status').innerText = 'error';
            console.log('---error---');
            console.log(ev);

            var raw = document.getElementById('raw');
            raw.innerHTML = ev + '<br>';
        };

        ws.onmessage = function (ev) {
            mc++;
            var out = document.getElementById('raw');
            out.innerHTML = ev.data;
            var data = JSON.parse(ev.data);
            // console.log(data);

            document.getElementById('mc').innerHTML = mc;

            var now = Date.now();
            var diff = now - (data.time / 1e6);
            document.getElementById('delay').innerText = parseFloat(diff).toFixed(3);
            document.getElementById('client_t').innerText = now * 1e6;
            document.getElementById('server_t').innerText = data.time;
        };

        ws.onclose = function () {
            document.getElementById('status').innerHTML = 'disconnected';
            dced = true;
            console.log('disconnected');
        };

        setInterval(function () {
            if (!dced) {
                ws.send('ping');
                // console.log('ping');
            }
        }, 1000); // 1sn intervals
    }

    function TestDC () {
        ws.close();
    }

    window.onload = function () {
        console.log('onload');

        document.getElementById('test_btn').onclick = TestStart;
        document.getElementById('dc_btn').onclick = TestDC;
    }
</script>
</body>
</html>